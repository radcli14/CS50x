{% extends "layout.html" %}

{% block title %}
    Lists
{% endblock %}

{% block main %}

    <div class="d-flex flex-column align-items-center"> 
        <h1>Lists for {{ data.username }}</h1>

        <h3>Trips</h3>

        <!-- The button toolbar at the top, with previous, next, and new buttons -->
        <div class="btn-toolbar mb-3" role="toolbar" aria-label="Toolbar with button groups">
            <div class="btn-group me-2" role="group" aria-label="Navigation group">
                <button type="button" class="btn btn-secondary" id="prev-btn" disabled>Previous</button>
                <button type="button" class="btn btn-secondary" id="next-btn" disabled>Next</button>
            </div>
            <div class="btn-group" role="group" aria-label="New List">
                <button type="button" class="btn btn-primary">New List</button>
            </div>
        </div>

        <!-- The trip card, making up the majority of the screen content -->
        <div id="trip-cards-container" class="w-100"> 
            {% for trip in trips %}
                <div class="card trip-card w-100 mb-3 shadow-lg border-0" style="max-width: 600px; margin: 0 auto;">
                    <div class="card-body">

                        <h5 class="card-title">
                            <input type="text" value="{{ trip.date }}" class="trip-date-display text-center" readonly style="border: none; background: transparent; font-weight: bold; width: auto;">
                        </h5>

                        <!-- The dropdown menu to select the store from the list of stores -->
                        <div class="store-data d-none">{{ stores | tojson }}</div>

                        <select class="form-select mb-2 d-inline store-name-select" data-original-name="{{ trip.name }}" style="max-width: 200px; width: auto;">
                            <option value="" disabled>Select a Store</option>
                            
                            {% for store in stores %}
                                <option value="{{ store.name }}" 
                                        data-store-id="{{ store.id }}" 
                                        data-address="{{ store.address }}"
                                        {% if store.name == trip.name %}selected{% endif %}>
                                    {{ store.name }}
                                </option>
                            {% endfor %}

                            {% if trip.name not in stores | map(attribute='name') | list %}
                                <option value="{{ trip.name }}" selected>{{ trip.name }} (Unlisted)</option>
                            {% endif %}
                        </select>

                        <h6 class="card-subtitle mb-2 text-muted fw-light current-trip-address">{{ trip.address }}</h6>
                        
                        <!-- Summary of the trip (editable) -->
                        <textarea class="form-control trip-summary-input mb-2 text-center">{{ trip.summary }}</textarea>

                        <!-- The list of all items on the shopping list -->
                        <table class="table trip-item-table">
                            <thead>
                                <th></th>
                                <th>Item</th>
                                <th>Quantity</th>
                                <th></th>
                            </thead>
                            <tbody>
                                {% for item in trip.Lists %}
                                    <tr data-item-id="{{ item.id }}">
                                        <td>
                                            <button type="button" class="btn btn-outline-success btn-sm check-item-btn">&#10003;</button>
                                        </td>
                                        <td>
                                            <input type="text" class="form-control item-name-input" value="{{ item.name }}">
                                        </td>
                                        <td>
                                            <input type="number" class="form-control item-quantity-input" value="{{ item.quantity }}" min="1">
                                        </td>
                                        <td>
                                            <button type="button" class="btn btn-outline-danger btn-sm delete-item-btn">&times;</button>
                                        </td>
                                    </tr>
                                {% endfor %}

                                <!-- A row at the bottom that lets the user enter a new item -->
                                <tr class="new-item-row">
                                    <td></td>
                                    <td><input type="text" class="form-control new-item-name" placeholder="New Item"></td>
                                    <td><input type="number" class="form-control new-item-quantity" value="1" min="1"></td>
                                    <td></td>
                                </tr>
                            </tbody>
                        </table>
                    </div>

                    <!-- A save button that is visible if data has been modified -->
                    <div class="card-footer text-center d-none save-button-container">
                        <button type="button" class="btn btn-primary save-list-btn" data-trip-id="{{ trip.id }}">
                            Save Changes
                        </button>
                    </div>
                </div>
            {% endfor %}
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', function() {
            const tripCards = document.querySelectorAll('.trip-card');
            const prevBtn = document.getElementById('prev-btn');
            const nextBtn = document.getElementById('next-btn');
            let currentIndex;

            // On load, the most recent (last in the list) "trip" should be visible
            // The most recent card in the list corresponds to the highest index.
            if (tripCards.length > 0) {
                currentIndex = tripCards.length - 1;

                // Function to show the current card and hide others
                function updateDisplay() {
                    tripCards.forEach((card, index) => {
                        // Hide all cards initially using Bootstrap's d-none class
                        card.classList.add('d-none');
                    });

                    // Show the card at the current index
                    tripCards[currentIndex].classList.remove('d-none');

                    // Update button states
                    prevBtn.disabled = currentIndex === 0;
                    nextBtn.disabled = currentIndex === tripCards.length - 1;
                }

                // Initial display update
                updateDisplay();

                // On tapping the previous/next buttons should change the index
                prevBtn.addEventListener('click', () => {
                    if (currentIndex > 0) {
                        currentIndex--;
                        updateDisplay();
                    }
                });

                nextBtn.addEventListener('click', () => {
                    if (currentIndex < tripCards.length - 1) {
                        currentIndex++;
                        updateDisplay();
                    }
                });

            } else {
                // If there are no trips, disable navigation buttons
                prevBtn.disabled = true;
                nextBtn.disabled = true;
            }

            // === Logic for Store Dropdown Selection ===

            const storeNameSelects = document.querySelectorAll('.store-name-select');

            storeNameSelects.forEach(select => {
                select.addEventListener('change', function() {
                    const card = this.closest('.card');
                    const selectedOption = this.options[this.selectedIndex];
                    
                    // 1. Update Address
                    const newAddress = selectedOption.getAttribute('data-address');
                    const addressElement = card.querySelector('.current-trip-address');
                    addressElement.textContent = newAddress;
                    
                    // 2. Show Save Button
                    const saveButtonContainer = card.querySelector('.save-button-container');
                    saveButtonContainer.classList.remove('d-none');
                });
            });

                // === Make summary editable and show Save button on change ===
                const summaryInputs = document.querySelectorAll('.trip-summary-input');
                summaryInputs.forEach(input => {
                    input.addEventListener('input', function() {
                        const card = this.closest('.card');
                        const saveButtonContainer = card.querySelector('.save-button-container');
                        if (this.value.trim().length > 0) {
                            saveButtonContainer.classList.remove('d-none');
                        } else {
                            // If summary cleared and no other changes, keep save visible so user can intentionally clear summary
                            saveButtonContainer.classList.remove('d-none');
                        }
                    });
                });
        });

        // Add interactivity to the checklist buttons and item controls
        function attachCheckHandler(button) {
            button.addEventListener('click', function() {
                // Toggle the style/state of the button
                this.classList.toggle('btn-outline-success');
                this.classList.toggle('btn-success');

                // Find the parent <tr> and visually cross out the row
                const row = this.closest('tr');
                row.classList.toggle('text-decoration-line-through');
                row.classList.toggle('table-success');
                // Show save when toggled
                const card = this.closest('.card');
                card.querySelector('.save-button-container').classList.remove('d-none');
            });
        }

        function attachDeleteHandler(button) {
            button.addEventListener('click', function() {
                const row = this.closest('tr');
                const card = this.closest('.card');
                row.remove();
                card.querySelector('.save-button-container').classList.remove('d-none');
            });
        }

        function attachItemInputHandlers(input) {
            input.addEventListener('input', function() {
                const card = this.closest('.card');
                card.querySelector('.save-button-container').classList.remove('d-none');
            });
        }

        // Attach handlers for existing controls on page load
        document.querySelectorAll('.check-item-btn').forEach(attachCheckHandler);
        document.querySelectorAll('.delete-item-btn').forEach(attachDeleteHandler);
        document.querySelectorAll('.item-name-input').forEach(attachItemInputHandlers);
        document.querySelectorAll('.item-quantity-input').forEach(attachItemInputHandlers);

        // === Logic for Adding New Items and Showing Save Button ===
        const newItemInputs = document.querySelectorAll('.new-item-name');

        newItemInputs.forEach(input => {
            const card = input.closest('.card');
            const saveButtonContainer = card.querySelector('.save-button-container');
            const tableBody = card.querySelector('.trip-item-table tbody');
            const quantityInput = card.querySelector('.new-item-quantity');

            function addNewItem(name, quantity) {
                const newRow = document.createElement('tr');
                // leave data-item-id empty for new items (to be assigned by backend)

                const buttonCell = document.createElement('td');
                buttonCell.innerHTML = `<button type="button" class="btn btn-outline-success btn-sm check-item-btn">&#10003;</button>`;
                newRow.appendChild(buttonCell);

                const nameCell = document.createElement('td');
                const nameInput = document.createElement('input');
                nameInput.type = 'text';
                nameInput.className = 'form-control item-name-input';
                nameInput.value = name;
                nameCell.appendChild(nameInput);
                newRow.appendChild(nameCell);

                const quantityCell = document.createElement('td');
                const qtyInput = document.createElement('input');
                qtyInput.type = 'number';
                qtyInput.className = 'form-control item-quantity-input';
                qtyInput.value = quantity;
                qtyInput.min = 1;
                quantityCell.appendChild(qtyInput);
                newRow.appendChild(quantityCell);

                const deleteCell = document.createElement('td');
                const delButton = document.createElement('button');
                delButton.type = 'button';
                delButton.className = 'btn btn-outline-danger btn-sm delete-item-btn';
                delButton.innerHTML = '&times;';
                deleteCell.appendChild(delButton);
                newRow.appendChild(deleteCell);

                // Insert before the new-item-row
                const newItemRow = card.querySelector('.new-item-row');
                tableBody.insertBefore(newRow, newItemRow);

                // Attach handlers
                attachCheckHandler(newRow.querySelector('.check-item-btn'));
                attachDeleteHandler(newRow.querySelector('.delete-item-btn'));
                attachItemInputHandlers(nameInput);
                attachItemInputHandlers(qtyInput);

                // Show save
                saveButtonContainer.classList.remove('d-none');
            }

            // show save when typing in the new item input
            input.addEventListener('input', function() {
                if (this.value.trim().length > 0) {
                    saveButtonContainer.classList.remove('d-none');
                } else if (tableBody.querySelectorAll('tr').length === 1) {
                    saveButtonContainer.classList.add('d-none');
                }
            });

            // Enter key adds the item
            input.addEventListener('keypress', function(e) {
                if (e.key === 'Enter' && this.value.trim() !== "") {
                    e.preventDefault();
                    addNewItem(this.value.trim(), quantityInput.value || 1);
                    this.value = '';
                    quantityInput.value = 1;
                }
            });

            // Blur should also add the item (mobile tapping outside)
            input.addEventListener('blur', function(e) {
                const val = this.value.trim();
                if (val !== "") {
                    // Delay slightly to allow potential Enter handler to run first
                    setTimeout(() => {
                        // If value still present (not cleared by enter handler), add it
                        if (this.value.trim() === val) {
                            addNewItem(val, quantityInput.value || 1);
                            this.value = '';
                            quantityInput.value = 1;
                        }
                    }, 50);
                }
            });
        });


        // === Logic for Save Button Click (API POST preparation) ===
        const saveButtons = document.querySelectorAll('.save-list-btn');

        saveButtons.forEach(button => {
            button.addEventListener('click', function() {
                const card = this.closest('.card');
                const tripId = this.getAttribute('data-trip-id');

                const dateInput = card.querySelector('.trip-date-display');
                const tableRows = card.querySelectorAll('.trip-item-table tbody tr:not(.new-item-row)');
                
                // Capture current store and trip data
                const storeSelect = card.querySelector('.store-name-select');
                const tripName = storeSelect.value;
                const tripAddress = card.querySelector('.current-trip-address').textContent.trim();
                const tripSummary = card.querySelector('.trip-summary-input').value.trim();

                // Get the selected option element
                const selectedOption = storeSelect.options[storeSelect.selectedIndex];
                const storeId = selectedOption ? selectedOption.getAttribute('data-store-id') : null; // Capture the Store ID

                // Build the data structure to send to the API
                const listData = [];
                tableRows.forEach(row => {
                    const itemId = row.getAttribute('data-item-id');
                    const nameInput = row.querySelector('.item-name-input');
                    const qtyInput = row.querySelector('.item-quantity-input');
                    const nameVal = nameInput ? nameInput.value.trim() : '';
                    const qtyVal = qtyInput ? parseInt(qtyInput.value) || 1 : 1;

                    // Only save the item if its name is present
                    if (nameVal !== "") {
                        listData.push({
                            id: itemId,
                            name: nameVal,
                            quantity: qtyVal
                        });
                    }
                });

                console.log(`Sending list for Trip ID: ${tripId}`, listData);

                // --- API Call ---
                fetch('/lists_save', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        // Include any necessary CSRF tokens here
                    },
                    body: JSON.stringify({
                        trip_id: tripId,
                        summary: tripSummary,
                        store_id: storeId,
                        date: dateInput.value,
                        store_name: tripName,
                        store_address: tripAddress,
                        items: listData,
                    })
                })
                .then(response => response.json())
                .then(data => {
                    alert('List saved successfully!');
                    // Hide the save button after successful save
                    card.querySelector('.save-button-container').classList.add('d-none');
                })
                .catch(error => {
                    console.error('Error saving list:', error);
                    alert(`Failed to save list because ${error.message}`);
                });
            });
        });

    </script>

{% endblock %}